<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Circuit Designer (Preview)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Scrollbar hiding */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useMemo, useEffect } = React;

    // ==========================================
    // Data Source: Panel Presets
    // ==========================================
    const DEFAULT_PANEL_PRESETS = [
      { manufacturer: "Aiko Energy Japan", model: "AIKO-G640-MCH72Dｗ", vmp: 45.11, imp: 14.19, pmax: 640, voc: 54.3, isc: 14.96, tempCoeffVoc: -0.26, tempCoeffIsc: 0.05 },
      { manufacturer: "Aiko Energy Japan", model: "AIKO-A615-MAH72Mw", vmp: 45.51, imp: 13.51, pmax: 615, voc: 53.7, isc: 14.09, tempCoeffVoc: -0.24, tempCoeffIsc: 0.05 },
      { manufacturer: "Chint New Energy", model: "CHSM78N(DG)/F-BH635", vmp: 46.62, imp: 13.62, pmax: 635, voc: 56.41, isc: 14.27, tempCoeffVoc: -0.29, tempCoeffIsc: "" },
      { manufacturer: "Chint New Energy", model: "CHSM78N(DG)/F-BH650", vmp: 47.12, imp: 13.8, pmax: 650, voc: 57.01, isc: 14.51, tempCoeffVoc: -0.29, tempCoeffIsc: 0.36 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72N(DG)/ FB-575", vmp: 42.94, imp: 13.39, pmax: 575, voc: 51.1, isc: 14.19, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72N(DG)/ FB-580", vmp: 43.11, imp: 13.45, pmax: 580, voc: 51.3, isc: 14.28, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72N(DG)/ FB-585", vmp: 43.27, imp: 13.52, pmax: 585, voc: 51.5, isc: 14.36, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72N(DG)/ FB-590", vmp: 43.45, imp: 13.58, pmax: 590, voc: 51.7, isc: 14.45, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72M(DG)/FB595", vmp: 43.61, imp: 13.64, pmax: 595, voc: 51.9, isc: 14.53, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72M(DG)/FB600", vmp: 43.78, imp: 13.7, pmax: 600, voc: 52.1, isc: 14.61, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72M(DG)/FB605", vmp: 43.95, imp: 13.77, pmax: 605, voc: 52.3, isc: 14.7, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "CHINT NEW ENERGY JAPAN", model: "CHSM72M(DG)/FB610", vmp: 44.12, imp: 13.83, pmax: 610, voc: 52.5, isc: 14.78, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "JASOLAR", model: "JAM66D46710/LB", vmp: 48.6, imp: 17.4, pmax: 710, voc: 48.6, isc: 18.51, tempCoeffVoc: -0.29, tempCoeffIsc: 0.045 },
      { manufacturer: "Leapton Energy", model: "LP182*182-M-78-MH-600W", vmp: 45.2, imp: 13.27, pmax: 600, voc: 54.1, isc: 14.08, tempCoeffVoc: -0.28, tempCoeffIsc: 0.36 },
      { manufacturer: "Leapton Energy", model: "LP182*182-M-78-NB-620W", vmp: 45.76, imp: 13.55, pmax: 620, voc: 55.61, isc: 14.09, tempCoeffVoc: -0.3, tempCoeffIsc: 0.046 },
      { manufacturer: "LONGi Solar Technology", model: "LR7-72HGD-615M", vmp: 44.22, imp: 13.91, pmax: 615, voc: 52.66, isc: 14.77, tempCoeffVoc: -0.28, tempCoeffIsc: 0.045 },
      { manufacturer: "LONGi Solar Technology", model: "LR7-72HGD-610M", vmp: 44.11, imp: 13.83, pmax: 610, voc: 52.55, isc: 14.69, tempCoeffVoc: -0.28, tempCoeffIsc: 0.045 },
      { manufacturer: "LONGi Solar Technology", model: "LR5-72HGD-590M", vmp: 43.44, imp: 13.59, pmax: 590, voc: 51.63, isc: 14.38, tempCoeffVoc: -0.28, tempCoeffIsc: 0.045 },
      { manufacturer: "LONGi Solar Technology", model: "LR-7-72HYD-660M", vmp: 44.85, imp: 14.72, pmax: 660, voc: 54, isc: 15.41, tempCoeffVoc: -0.26, tempCoeffIsc: "" },
      { manufacturer: "XSOL", model: "XLN108-460S", vmp: 33.17, imp: 13.87, pmax: 460, voc: 39.7, isc: 14.64, tempCoeffVoc: -0.29, tempCoeffIsc: 0.045 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-580TB-AG", vmp: 43.1, imp: 13.46, pmax: 580, voc: 52.2, isc: 13.93, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-560TB-AG", vmp: 42.3, imp: 13.24, pmax: 560, voc: 51.4, isc: 13.69, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-565TB-AG", vmp: 42.5, imp: 13.3, pmax: 565, voc: 51.6, isc: 13.3, tempCoeffVoc: 0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-575TB-AG", vmp: 42.9, imp: 13.41, pmax: 575, voc: 52, isc: 13.88, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6R-440T", vmp: 32.4, imp: 13.59, pmax: 440, voc: 39.4, isc: 14.01, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-570TB-AG", vmp: 42.7, imp: 13.35, pmax: 570, voc: 51.8, isc: 13.81, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-585T", vmp: 43.3, imp: 13.52, pmax: 585, voc: 52.4, isc: 14, tempCoeffVoc: -0.29, tempCoeffIsc: "" },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-585T (AG)", vmp: 43.3, imp: 13.52, pmax: 585, voc: 52.4, isc: 14, tempCoeffVoc: -0.25, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6R-415MS", vmp: 31.4, imp: 13.23, pmax: 415, voc: 37.4, isc: 14.09, tempCoeffVoc: -0.26, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6.1-72TB-610", vmp: 44.4, imp: 13.74, pmax: 610, voc: 52.2, isc: 14.66, tempCoeffVoc: -0.29, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-585TB-AG", vmp: 43.3, imp: 13.52, pmax: 585, voc: 52.4, isc: 14, tempCoeffVoc: -0.29, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-590TB-AG", vmp: 43.5, imp: 13.57, pmax: 590, voc: 52.6, isc: 14.06, tempCoeffVoc: -0.29, tempCoeffIsc: 0.05 },
      { manufacturer: "カナディアンソーラージャパン", model: "CS6W-595TB-AG", vmp: 43.7, imp: 13.62, pmax: 595, voc: 52.8, isc: 14.12, tempCoeffVoc: -0.29, tempCoeffIsc: 0.05 },
      { manufacturer: "サンテック", model: "STP585S-C72/Nsh+", vmp: 42.79, imp: 13.67, pmax: 585, voc: 51.55, isc: 14.4, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "サンテックエナジー", model: "STP555S-C72", vmp: 42.24, imp: 13.14, pmax: 555, voc: 50.07, isc: 14.07, tempCoeffVoc: -0.26, tempCoeffIsc: 0.05 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM580N-72HL4-BDV-J", vmp: 43.88, imp: 13.22, pmax: 580, voc: 52.5, isc: 13.95, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM550N-72HL4-BDV", vmp: 41.58, imp: 13.23, pmax: 550, voc: 50.27, isc: 14.01, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM555N-72HL4-BDV", vmp: 41.77, imp: 13.29, pmax: 555, voc: 50.47, isc: 14.07, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM560N-72HL4-BDV", vmp: 41.95, imp: 13.35, pmax: 560, voc: 50.67, isc: 14.13, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM565N-72HL4-BDV", vmp: 42.14, imp: 13.41, pmax: 565, voc: 50.87, isc: 14.19, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM570N-72HL4-BDV", vmp: 42.29, imp: 13.48, pmax: 570, voc: 51.07, isc: 14.25, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM590N-78HL4-BDV", vmp: 44.91, imp: 13.14, pmax: 590, voc: 54.76, isc: 13.71, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM595N-78HL4-BDV", vmp: 45.08, imp: 13.2, pmax: 595, voc: 54.9, isc: 13.79, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM600N-78HL4-BDV", vmp: 45.25, imp: 13.26, pmax: 600, voc: 55.03, isc: 13.87, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM605N-78HL4-BDV", vmp: 45.42, imp: 13.32, pmax: 605, voc: 55.17, isc: 13.95, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM610N-78HL4-BDV", vmp: 45.6, imp: 13.38, pmax: 610, voc: 55.31, isc: 14.03, tempCoeffVoc: -0.25, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM585N-72HL4-V-J", vmp: 43.48, imp: 13.44, pmax: 585, voc: 52.47, isc: 14.07, tempCoeffVoc: -0.24, tempCoeffIsc: 0.046 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM625N-78HL4-BDV-J", vmp: 47.54, imp: 13.15, pmax: 625, voc: 56.95, isc: 13.8, tempCoeffVoc: -0.25, tempCoeffIsc: 0.045 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM585N-72HL4-BDV-J", vmp: 44.02, imp: 13.29, pmax: 585, voc: 52.7, isc: 14.01, tempCoeffVoc: -0.25, tempCoeffIsc: 0.045 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM590N-72HL4-BDV-J", vmp: 44.17, imp: 13.36, pmax: 590, voc: 52.9, isc: 14.07, tempCoeffVoc: -0.29, tempCoeffIsc: 0.8 },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM635N-78HL4-BDV-J", vmp: 47.86, imp: 13.27, pmax: 635, voc: 57.21, isc: 13.92, tempCoeffVoc: -0.29, tempCoeffIsc: "" },
      { manufacturer: "ジンコ・ソーラージャパン", model: "JKM720N-66HL5-BDV", vmp: 40.89, imp: 17.61, pmax: 720, voc: 49.04, isc: 18.67, tempCoeffVoc: -0.29, tempCoeffIsc: "" },
      { manufacturer: "トリナソーラージャパン", model: "TSM-590NEG19RC.20", vmp: 39.7, imp: 14.86, pmax: 590, voc: 47.8, isc: 15.72, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-595NEG19RC.20", vmp: 40, imp: 14.89, pmax: 595, voc: 48.1, isc: 15.76, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-600NEG19RC.20", vmp: 40.3, imp: 14.91, pmax: 600, voc: 48.4, isc: 15.8, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-605NEG19RC.20", vmp: 40.5, imp: 14.94, pmax: 605, voc: 48.7, isc: 15.73, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-610NEG19RC.20", vmp: 40.8, imp: 14.96, pmax: 610, voc: 49, isc: 15.86, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-615NEG19RC.20", vmp: 41.1, imp: 14.98, pmax: 615, voc: 49.3, isc: 15.89, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-620NEG19RC.20", vmp: 41.4, imp: 14.99, pmax: 620, voc: 49.6, isc: 15.91, tempCoeffVoc: -0.24, tempCoeffIsc: 0.04 },
      { manufacturer: "トリナソーラージャパン", model: "TSM-700NEG21C.20", vmp: 40.5, imp: 17.29, pmax: 700, voc: 48.6, isc: 18.32, tempCoeffVoc: -0.29, tempCoeffIsc: 0.04 },
      { manufacturer: "ネクストエナジー", model: "NER156M590B-MDD", vmp: 44.8, imp: 13.17, pmax: 590, voc: 53.3, isc: 13.93, tempCoeffVoc: -0.275, tempCoeffIsc: 0.045 },
      { manufacturer: "ネクストエナジー", model: "NER108M435E-ND", vmp: 32.99, imp: 13.18, pmax: 435, voc: 39.26, isc: 13.97, tempCoeffVoc: -0.25, tempCoeffIsc: 0.043 },
      { manufacturer: "JA Solar", model: "JAM66D46-720", vmp: 41.19, imp: 17.48, pmax: 720, voc: 49, isc: 18.59, tempCoeffVoc: -0.25, tempCoeffIsc: 0.04 }
    ];

    // ==========================================
    // Data Source (Simulating src/data/pcsPresets.json)
    // ==========================================
    const PCS_PRESETS = [
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-111KTL-NHM0",
        ratedPower: 111100,
        totalCircuits: 20,
        mpptCount: 10,
        ratedInputVoltage: 670,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 26,
        maxIscPerCircuit: 40,
        maxIscTotal: 800,
        efficiency: 98.8
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-63KTL-JPM0",
        ratedPower: 62500,
        totalCircuits: 12,
        mpptCount: 6,
        ratedInputVoltage: 670,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 22,
        maxIscPerCircuit: 30,
        maxIscTotal: 360,
        efficiency: 98.9
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-50KTL-JPM0",
        ratedPower: 50000,
        totalCircuits: 12,
        mpptCount: 6,
        ratedInputVoltage: 670,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 22,
        maxIscPerCircuit: 30,
        maxIscTotal: 360,
        efficiency: 98.9
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-33KTL-NH",
        ratedPower: 33000,
        totalCircuits: 8,
        mpptCount: 4,
        ratedInputVoltage: 650,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 26,
        maxIscPerCircuit: 40,
        maxIscTotal: 320,
        efficiency: 98.8
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-40KTL-NH",
        ratedPower: 40000,
        totalCircuits: 8,
        mpptCount: 4,
        ratedInputVoltage: 650,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 26,
        maxIscPerCircuit: 40,
        maxIscTotal: 320,
        efficiency: 98.8
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-4.95KTL-NHL2",
        ratedPower: 4950,
        totalCircuits: 4,
        mpptCount: 2,
        ratedInputVoltage: 340,
        startupVoltage: 90,
        maxInputVoltage: 600,
        mpptMinVoltage: 90,
        mpptMaxVoltage: 560,
        maxInputCurrentPerCircuit: 16,
        maxIscPerCircuit: 30,
        maxIscTotal: 120,
        efficiency: 97.5
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-4.95KTL-JPL1",
        ratedPower: 4950,
        totalCircuits: 4,
        mpptCount: 2,
        ratedInputVoltage: 320,
        startupVoltage: 90,
        maxInputVoltage: 600,
        mpptMinVoltage: 90,
        mpptMaxVoltage: 560,
        maxInputCurrentPerCircuit: 16,
        maxIscPerCircuit: 25,
        maxIscTotal: 100,
        efficiency: 97.0
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-50KTL-NHM3",
        ratedPower: 50000,
        totalCircuits: 8,
        mpptCount: 4,
        ratedInputVoltage: 650,
        startupVoltage: 200,
        maxInputVoltage: 1100,
        mpptMinVoltage: 200,
        mpptMaxVoltage: 1000,
        maxInputCurrentPerCircuit: 30,
        maxIscPerCircuit: 40,
        maxIscTotal: 320,
        efficiency: 98.5
      },
      {
        manufacturer: "ファーウェイ",
        model: "SUN2000-125KTL-JPH0",
        ratedPower: 125000,
        totalCircuits: 18,
        mpptCount: 9,
        ratedInputVoltage: 900,
        startupVoltage: 550,
        maxInputVoltage: 1500,
        mpptMinVoltage: 500,
        mpptMaxVoltage: 1500,
        maxInputCurrentPerCircuit: 30,
        maxIscPerCircuit: 50,
        maxIscTotal: 900,
        efficiency: 98.8
      }
    ];

    // ==========================================
    // Logic: stringDesign.ts
    // ==========================================

    function calculateVocCold(panel, minTemp) {
      const tempCoeffVocFraction = panel.tempCoeffVoc / 100;
      const deltaT = minTemp - 25;
      const vocColdModule = panel.voc * (1 + tempCoeffVocFraction * deltaT);
      return vocColdModule;
    }

    function calculateAllowedSeriesRange(panel, pcs, vocColdModule) {
      const nMinByMppt = Math.ceil(pcs.mpptMinVoltage / panel.vmp);
      const nMaxByMppt = Math.floor(pcs.mpptMaxVoltage / panel.vmp);
      const nMaxByVoc = Math.floor(pcs.maxInputVoltage / vocColdModule);
      const nMin = nMinByMppt;
      const nMax = Math.min(nMaxByMppt, nMaxByVoc);

      if (nMin > nMax) {
        return { 
            min: 0, max: 0, 
            error: `設計不可能: MPPT範囲と最大電圧制約を満たす直列数が存在しません (Min:${nMin}, MaxByMppt:${nMaxByMppt}, MaxByVoc:${nMaxByVoc})` 
        };
      }
      return { min: nMin, max: nMax };
    }

    function selectBestSeriesCount(range, panel, pcsList) {
      return range.max;
    }

    function checkCurrentConstraints(panel, pcs, stringDesign) {
      const warnings = [];
      if (panel.imp > pcs.maxInputCurrentPerCircuit) {
        warnings.push(`警告: パネルImp(${panel.imp}A)がPCS回路最大電流(${pcs.maxInputCurrentPerCircuit}A)を超過`);
      }
      if (panel.isc > pcs.maxIscPerCircuit) {
        warnings.push(`警告: パネルIsc(${panel.isc}A)がPCS回路最大短絡電流(${pcs.maxIscPerCircuit}A)を超過`);
      }
      return warnings;
    }

    function checkVoltageConstraints(pcs, vmp, voc) {
      const warnings = [];
      if (vmp < pcs.mpptMinVoltage) warnings.push(`警告: 動作電圧(${vmp.toFixed(1)}V)がMPPT下限(${pcs.mpptMinVoltage}V)未満`);
      if (vmp > pcs.mpptMaxVoltage) warnings.push(`警告: 動作電圧(${vmp.toFixed(1)}V)がMPPT上限(${pcs.mpptMaxVoltage}V)超過`);
      if (voc > pcs.maxInputVoltage) warnings.push(`警告: 低温時開放電圧(${voc.toFixed(1)}V)が最大入力(${pcs.maxInputVoltage}V)超過`);
      return warnings;
    }

    function calculateDesign(_panel, _pcsList, _condition) {
      // --- Data Sanitization: Ensure all numbers are actually numbers ---
      const panel = {
        ..._panel,
        voc: Number(_panel.voc) || 0,
        vmp: Number(_panel.vmp) || 0,
        isc: Number(_panel.isc) || 0,
        imp: Number(_panel.imp) || 0,
        pmax: Number(_panel.pmax) || 0,
        moduleCount: Number(_panel.moduleCount) || 0,
        tempCoeffVoc: Number(_panel.tempCoeffVoc) || 0,
        tempCoeffIsc: Number(_panel.tempCoeffIsc) || 0,
      };
      
      const condition = {
        ..._condition,
        minTemperature: Number(_condition.minTemperature) || 0,
        targetOverloadRatio: Number(_condition.targetOverloadRatio) || 0,
        manualSeriesCount: Number(_condition.manualSeriesCount) || 0,
      };

      const pcsList = _pcsList.map(pcs => ({
        ...pcs,
        ratedPower: Number(pcs.ratedPower) || 0,
        totalCircuits: Number(pcs.totalCircuits) || 0,
        mpptCount: Number(pcs.mpptCount) || 0,
        ratedInputVoltage: Number(pcs.ratedInputVoltage) || 0,
        startupVoltage: Number(pcs.startupVoltage) || 0,
        maxInputVoltage: Number(pcs.maxInputVoltage) || 0,
        mpptMinVoltage: Number(pcs.mpptMinVoltage) || 0,
        mpptMaxVoltage: Number(pcs.mpptMaxVoltage) || 0,
        maxInputCurrentPerCircuit: Number(pcs.maxInputCurrentPerCircuit) || 0,
        maxIscPerCircuit: Number(pcs.maxIscPerCircuit) || 0,
        maxIscTotal: Number(pcs.maxIscTotal) || 0,
        efficiency: Number(pcs.efficiency) || 0,
      }));
      // ------------------------------------------------------------

      const vocColdModule = calculateVocCold(panel, condition.minTemperature);
      
      if (pcsList.length === 0) return createEmptyResult();

      const representativePcs = pcsList[0];
      const range = calculateAllowedSeriesRange(panel, representativePcs, vocColdModule);
      
      const globalWarnings = [];
      if (range.error) {
        globalWarnings.push(range.error);
      }

      let seriesCount = 0;
      if (condition.manualSeriesCount && condition.manualSeriesCount > 0) {
        const manualN = condition.manualSeriesCount;
        seriesCount = manualN;
        if (manualN < range.min || manualN > range.max) {
            globalWarnings.push(`警告: 指定された直列数(${manualN})は推奨範囲(${range.min}〜${range.max}枚)外です。電圧制約に違反する可能性があります。`);
        }
      } else {
        seriesCount = range.max > 0 ? selectBestSeriesCount(range, panel, pcsList) : 0;
      }

      const stringDesign = {
        seriesModules: seriesCount,
        vmpString: panel.vmp * seriesCount,
        vocStringCold: vocColdModule * seriesCount
      };

      // 割り当てロジック (Round-Robin)
      let remainingModules = panel.moduleCount;
      const assignments = [];
      const summaries = [];

      let totalPvCapacityW = 0;
      let totalPcsCapacityW = 0;
      
      const totalStrings = seriesCount > 0 ? Math.floor(panel.moduleCount / seriesCount) : 0;
      remainingModules -= totalStrings * seriesCount;

      // マップ準備
      const assignedMap = new Map();
      const nextCircuitIndex = pcsList.map(() => 1); 
      let stringsToAssign = totalStrings;
      
      while (stringsToAssign > 0) {
        let assignedInThisRound = false;
        for (let i = 0; i < pcsList.length; i++) {
            if (stringsToAssign <= 0) break;
            const pcs = pcsList[i];
            const circuitIdx = nextCircuitIndex[i];
            if (circuitIdx <= pcs.totalCircuits) {
                assignedMap.set(`${pcs.id}-${circuitIdx}`, true);
                nextCircuitIndex[i]++;
                stringsToAssign--;
                assignedInThisRound = true;
            }
        }
        if (!assignedInThisRound) break;
      }
      
      if (stringsToAssign > 0) {
          remainingModules += stringsToAssign * seriesCount;
      }

      // 結果構築
      for (const pcs of pcsList) {
        const pcsAssignments = []; 
        let modulesAssignedToPcs = 0;
        let usedCircuits = 0;
        let pcsWarnings = [];
        
        // 電圧チェックを追加
        if (seriesCount > 0) {
            pcsWarnings = [...pcsWarnings, ...checkVoltageConstraints(pcs, stringDesign.vmpString, stringDesign.vocStringCold)];
        }

        const circuitsPerMppt = Math.floor(pcs.totalCircuits / pcs.mpptCount);

        for (let i = 1; i <= pcs.totalCircuits; i++) {
          const mpptGroupIndex = Math.ceil(i / circuitsPerMppt);
          const isAssigned = assignedMap.get(`${pcs.id}-${i}`);
          let assignedString = null;

          if (isAssigned) {
            assignedString = { ...stringDesign };
            modulesAssignedToPcs += seriesCount;
            usedCircuits++;
          } 
          
          const assignmentData = {
            pcsId: pcs.id,
            circuitIndex: i,
            mpptGroupIndex: mpptGroupIndex,
            stringDesign: assignedString,
            currentImp: assignedString ? panel.imp : 0,
            currentIsc: assignedString ? panel.isc : 0
          };
          
          assignments.push(assignmentData);
          if (isAssigned) {
             pcsAssignments.push(assignmentData);
          }
        }

        // MPPT単位の電流チェック
        const mpptCounts = {};
        pcsAssignments.forEach(a => {
            mpptCounts[a.mpptGroupIndex] = (mpptCounts[a.mpptGroupIndex] || 0) + 1;
        });
        
        for (const [mpptIdx, count] of Object.entries(mpptCounts)) {
            const totalImp = count * panel.imp;
            const totalIsc = count * panel.isc;
            if (totalImp > pcs.maxInputCurrentPerCircuit) {
                pcsWarnings.push(`警告: MPPT${mpptIdx} 入力電流(${totalImp.toFixed(1)}A)が上限(${pcs.maxInputCurrentPerCircuit}A)を超過`);
            }
            if (totalIsc > pcs.maxIscPerCircuit) {
                pcsWarnings.push(`警告: MPPT${mpptIdx} 短絡電流(${totalIsc.toFixed(1)}A)が上限(${pcs.maxIscPerCircuit}A)を超過`);
            }
        }

        const pcsPvPower = modulesAssignedToPcs * panel.pmax;
        totalPvCapacityW += pcsPvPower;
        const overloadRatio = pcs.ratedPower > 0 ? (pcsPvPower / pcs.ratedPower) * 100 : 0;

        const totalIsc = usedCircuits * panel.isc;
        if (totalIsc > pcs.maxIscTotal) {
          pcsWarnings.push(`警告: PCS合計短絡電流(${totalIsc.toFixed(1)}A)が最大値(${pcs.maxIscTotal}A)を超過`);
        }
        if (overloadRatio < condition.targetOverloadRatio * 0.8 && pcs.ratedPower > 0) {
            pcsWarnings.push(`情報: 過積載率(${overloadRatio.toFixed(1)}%)が目標(${condition.targetOverloadRatio}%)より大幅に低いです`);
        }

        // 重複警告の削除
        pcsWarnings = [...new Set(pcsWarnings)];

        summaries.push({
          pcsId: pcs.id,
          totalModulesAssigned: modulesAssignedToPcs,
          usedCircuits,
          overloadRatio,
          warnings: pcsWarnings,
          pvCapacityKw: pcsPvPower / 1000,
          pcsCapacityKw: pcs.ratedPower / 1000
        });
        
        totalPcsCapacityW += pcs.ratedPower;
      }

      if (remainingModules > 0) {
        globalWarnings.push(`注意: ${remainingModules} 枚のパネルが配置されずに残っています。PCSを追加するか構成を見直してください。`);
      }

      const totalOverloadRatio = totalPcsCapacityW > 0 ? (totalPvCapacityW / totalPcsCapacityW) * 100 : 0;

      return {
        assignments,
        summaries,
        totalOverloadRatio,
        totalPvCapacityKw: totalPvCapacityW / 1000,
        totalPcsCapacityKw: totalPcsCapacityW / 1000,
        globalWarnings
      };
    }

    function createEmptyResult() {
      return {
        assignments: [],
        summaries: [],
        totalOverloadRatio: 0,
        totalPvCapacityKw: 0,
        totalPcsCapacityKw: 0,
        globalWarnings: []
      };
    }

    // --- Excel Export Logic ---
    const exportToExcel = (result, panel, pcsList, condition) => {
        if (!result) return;

        const wb = XLSX.utils.book_new();
        const now = new Date().toLocaleString();

        // --- Sheet 1: 設計サマリー ---
        const summaryRows = [
            ["Solar Circuit Designer - 設計シミュレーション結果報告書"],
            ["出力日時", now],
            [],
            ["【1. 設置条件】"],
            ["想定最低気温", `${condition.minTemperature} ℃`],
            ["目標過積載率", `${condition.targetOverloadRatio} %`],
            [],
            ["【2. パネル仕様】"],
            ["メーカー", panel.manufacturer],
            ["型式", panel.model],
            ["最大出力 (Pmax)", `${panel.pmax} W`],
            ["開放電圧 (Voc)", `${panel.voc} V`],
            ["動作電圧 (Vmp)", `${panel.vmp} V`],
            ["短絡電流 (Isc)", `${panel.isc} A`],
            ["動作電流 (Imp)", `${panel.imp} A`],
            ["温度係数(Voc)", `${panel.tempCoeffVoc} %/℃`],
            ["パネル総数", `${panel.moduleCount} 枚`],
            [],
            ["【3. 全体設計結果】"],
            ["PVシステム総容量", `${result.totalPvCapacityKw.toFixed(2)} kW`],
            ["PCS定格総出力", `${result.totalPcsCapacityKw.toFixed(2)} kW`],
            ["全体過積載率", `${result.totalOverloadRatio.toFixed(1)} %`],
            ["未配置パネル数", `${panel.moduleCount - result.summaries.reduce((acc, s) => acc + s.totalModulesAssigned, 0)} 枚`],
            [],
            ["【4. PCS別サマリー】"],
            ["PCS ID", "型式", "定格出力(kW)", "PV入力(kW)", "過積載率(%)", "使用回路数", "入力枚数", "判定"],
        ];

        result.summaries.forEach(s => {
            const pcs = pcsList.find(p => p.id === s.pcsId);
            const status = s.warnings.length > 0 ? `要確認: ${s.warnings.join(", ")}` : "OK";
            summaryRows.push([
                s.pcsId,
                pcs ? pcs.model : "-",
                s.pcsCapacityKw.toFixed(2),
                s.pvCapacityKw.toFixed(2),
                s.overloadRatio.toFixed(1),
                `${s.usedCircuits} / ${pcs ? pcs.totalCircuits : "-"}`,
                s.totalModulesAssigned,
                status
            ]);
        });
        
        // グローバル警告があれば追加
        if (result.globalWarnings.length > 0) {
            summaryRows.push([], ["【全体警告・注意事項】"]);
            result.globalWarnings.forEach(w => summaryRows.push([w]));
        }

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
        
        // 列幅調整 (簡易)
        wsSummary['!cols'] = [
            { wch: 25 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 50 }
        ];

        XLSX.utils.book_append_sheet(wb, wsSummary, "設計サマリー");

        // --- Sheet 2: 回路割付詳細 ---
        const detailHeader = [
            "PCS ID", "回路No", "MPPTグループ", "直列数(枚)", 
            "ストリングVmp(V)", "ストリングVoc低温(V)", 
            "パネルImp(A)", "パネルIsc(A)", 
            "判定/警告"
        ];
        
        const detailRows = [detailHeader];

        // Sort assignments by PCS ID then Circuit Index
        const sortedAssignments = [...result.assignments].sort((a, b) => {
            if (a.pcsId !== b.pcsId) return a.pcsId.localeCompare(b.pcsId);
            return a.circuitIndex - b.circuitIndex;
        });

        sortedAssignments.forEach(a => {
            const pcs = pcsList.find(p => p.id === a.pcsId);
            const n = a.stringDesign?.seriesModules || 0;
            let vmp = 0, voc = 0;
            let status = "未使用";
            
            if (n > 0) {
                vmp = a.stringDesign.vmpString;
                voc = a.stringDesign.vocStringCold;
                
                // 個別回路の警告チェック（簡易再判定）
                const warnings = [];
                // 電圧
                if (pcs) {
                    if (vmp < pcs.mpptMinVoltage) warnings.push(`Vmp下限割れ(${vmp.toFixed(1)}V)`);
                    if (vmp > pcs.mpptMaxVoltage) warnings.push(`Vmp上限超過(${vmp.toFixed(1)}V)`);
                    if (voc > pcs.maxInputVoltage) warnings.push(`最大入力超過(${voc.toFixed(1)}V)`);
                }
                status = warnings.length > 0 ? `NG: ${warnings.join(", ")}` : "OK";
            }

            detailRows.push([
                a.pcsId,
                a.circuitIndex,
                a.mpptGroupIndex,
                n > 0 ? n : "-",
                n > 0 ? vmp.toFixed(1) : "-",
                n > 0 ? voc.toFixed(1) : "-",
                n > 0 ? panel.imp : "-",
                n > 0 ? panel.isc : "-",
                status
            ]);
        });

        const wsDetail = XLSX.utils.aoa_to_sheet(detailRows);
        wsDetail['!cols'] = [
            { wch: 10 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, 
            { wch: 15 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 40 }
        ];

        XLSX.utils.book_append_sheet(wb, wsDetail, "回路割付詳細");

        // --- File Write ---
        const filename = `SolarDesign_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
    };

    // ==========================================
    // Components

    // ==========================================

    // --- Generic Input Field ---
    const InputField = ({ label, value, onChange, unit, type = "number", step = "any", min, error, disabled, bgClass = "bg-slate-50" }) => (
      <div className="space-y-1">
        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">{label}</label>
        <div className="relative">
          <input
            type={type}
            value={value}
            onChange={(e) => {
                const val = e.target.value;
                if (type === 'number') {
                    onChange(val === '' ? '' : parseFloat(val));
                } else {
                    onChange(val);
                }
            }}
            step={step}
            min={min}
            disabled={disabled}
            className={`w-full ${bgClass} border ${error ? 'border-red-300 focus:ring-red-200' : 'border-slate-200 focus:ring-indigo-200'} rounded-lg px-3 py-2 text-sm font-medium text-slate-700 focus:outline-none focus:ring-4 transition-all disabled:opacity-60 disabled:cursor-not-allowed`}
          />
          {unit && <span className="absolute right-3 top-2 text-xs text-slate-400 font-bold">{unit}</span>}
        </div>
        {error && <p className="text-xs text-red-500">{error}</p>}
      </div>
    );

    // --- Panel Form ---
    const PanelForm = ({ panel, onChange, onPresetSelect, presets, onSaveCustom }) => {
      const isCustom = !DEFAULT_PANEL_PRESETS.some(p => p.model === panel.model);
      // Use the passed presets prop for checking if it's in the list
      // But for "isEditable" check, we want to allow editing if it's NOT in the DEFAULT presets 
      // OR if it's in the custom ones? Usually once saved as preset, we treat it as read-only preset to avoid confusion.
      // But let's allow editing if the user explicitly selected "CUSTOM" which clears the model name.
      // If a model name is present and it matches ANY preset (default or custom), we disable fields.
      
      const isEditable = panel.model === '' || !presets.some(p => p.model === panel.model);

      return (
      <section className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
        <h2 className="flex items-center gap-2 text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">
          <i className="fa-solid fa-sun text-orange-500 text-xl"></i>
          パネル(モジュール)仕様
        </h2>

        {/* Preset Selector */}
        <div className="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
          <label className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">パネル型式選択</label>
          <div className="flex gap-2">
            <select 
                className="w-full p-2 rounded border border-slate-300 text-sm"
                value={isEditable ? "CUSTOM" : panel.model}
                onChange={(e) => onPresetSelect(e.target.value)}
            >
                <option value="" disabled>型式を選択してください</option>
                {presets.map(p => (
                <option key={p.model} value={p.model}>{p.manufacturer} | {p.model} ({p.pmax}W)</option>
                ))}
                <option value="CUSTOM">カスタム (手動入力)</option>
            </select>
          </div>
          <p className="text-xs text-red-500 mt-2 font-bold">
            ※ パネルの仕様は必ず仕様書を確認して数値が間違っていないか確認してください
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <InputField label="メーカー" value={panel.manufacturer} onChange={(v) => onChange('manufacturer', v)} type="text" disabled={!isEditable} />
          <InputField label="型式" value={panel.model} onChange={(v) => onChange('model', v)} type="text" disabled={!isEditable} />
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
          <InputField label="Pmax (定格出力)" value={panel.pmax} onChange={(v) => onChange('pmax', v)} unit="W" disabled={!isEditable} />
          <InputField label="Voc (開放電圧)" value={panel.voc} onChange={(v) => onChange('voc', v)} unit="V" disabled={!isEditable} />
          <InputField label="Vmp (動作電圧)" value={panel.vmp} onChange={(v) => onChange('vmp', v)} unit="V" disabled={!isEditable} />
          <InputField label="Isc (短絡電流)" value={panel.isc} onChange={(v) => onChange('isc', v)} unit="A" disabled={!isEditable} />
          <InputField label="Imp (動作電流)" value={panel.imp} onChange={(v) => onChange('imp', v)} unit="A" disabled={!isEditable} />
          <InputField 
            label="総枚数" 
            value={panel.moduleCount} 
            onChange={(v) => onChange('moduleCount', v)} 
            unit="枚" 
            bgClass="bg-yellow-50 border-yellow-200 focus:ring-yellow-100"
          />
          <InputField label="温度係数 (Voc)" value={panel.tempCoeffVoc} onChange={(v) => onChange('tempCoeffVoc', v)} unit="%/℃" disabled={!isEditable} />
          <InputField label="温度係数 (Isc)" value={panel.tempCoeffIsc} onChange={(v) => onChange('tempCoeffIsc', v)} unit="%/℃" disabled={!isEditable} />
          
          {/* Save Button for Custom */}
          {isEditable && (
            <div className="flex items-end">
                <button 
                    onClick={onSaveCustom}
                    className="h-[42px] w-full bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-lg font-bold text-xs hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1"
                    title="入力した内容をブラウザに保存します"
                >
                    <i className="fa-solid fa-save"></i>
                    プリセット保存
                </button>
            </div>
          )}

          {/* DC Capacity Display */}
          <div className="flex flex-col justify-end">
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">DC総容量 (計算値)</label>
              <div className="h-[42px] w-full bg-orange-50 border border-orange-200 rounded-lg px-3 flex items-center justify-between">
                <i className="fa-solid fa-bolt text-orange-400"></i>
                <div className="flex items-baseline gap-1">
                  <span className="text-lg font-bold text-orange-700">
                    {panel.pmax && panel.moduleCount ? ((panel.pmax * panel.moduleCount) / 1000).toFixed(2) : '0.00'}
                  </span>
                  <span className="text-xs font-bold text-orange-500">kW</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      );
    };

    // --- PCS List Form (Updated) ---
    const PcsListForm = ({ pcsList, onAdd, onRemove, onChange, onPresetSelect }) => (
      <section className="space-y-4">
        {pcsList.map((pcs, index) => {
           // Check if current model matches a preset
           const isCustom = !PCS_PRESETS.some(p => p.model === pcs.model);
           
           return (
          <div key={pcs.id} className="bg-white rounded-xl p-6 shadow-sm border border-slate-200 relative group">
            <div className="absolute top-4 right-4 flex gap-2">
              {pcsList.length > 1 && (
                <button onClick={() => onRemove(pcs.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="このPCSを削除">
                  <i className="fa-solid fa-trash"></i>
                </button>
              )}
            </div>
            <h2 className="flex items-center gap-2 text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">
              <i className="fa-solid fa-server text-blue-500 text-xl"></i>
              PCS仕様 ({pcs.id})
            </h2>
            
            {/* Preset Selector */}
            <div className="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
              <label className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">PCSモデル選択</label>
              <select 
                className="w-full p-2 rounded border border-slate-300 text-sm"
                value={isCustom ? "CUSTOM" : pcs.model}
                onChange={(e) => onPresetSelect(pcs.id, e.target.value)}
              >
                <option value="" disabled>モデルを選択してください</option>
                {PCS_PRESETS.map(p => (
                  <option key={p.model} value={p.model}>{p.manufacturer} | {p.model} ({p.ratedPower/1000}kW)</option>
                ))}
                <option value="CUSTOM">カスタム (手動入力)</option>
              </select>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <InputField label="メーカー" value={pcs.manufacturer} onChange={(v) => onChange(pcs.id, 'manufacturer', v)} type="text" disabled={!isCustom} />
              <InputField label="型式" value={pcs.model} onChange={(v) => onChange(pcs.id, 'model', v)} type="text" disabled={!isCustom} />
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              <InputField label="定格出力" value={pcs.ratedPower} onChange={(v) => onChange(pcs.id, 'ratedPower', v)} unit="W" disabled={!isCustom} />
              <InputField label="変換効率" value={pcs.efficiency} onChange={(v) => onChange(pcs.id, 'efficiency', v)} unit="%" disabled={!isCustom} />
              <InputField label="回路数" value={pcs.totalCircuits} onChange={(v) => onChange(pcs.id, 'totalCircuits', v)} unit="回路" disabled={!isCustom} />
              <InputField label="MPPT数" value={pcs.mpptCount} onChange={(v) => onChange(pcs.id, 'mpptCount', v)} unit="MPPT" disabled={!isCustom} />
              <InputField label="定格入力電圧" value={pcs.ratedInputVoltage} onChange={(v) => onChange(pcs.id, 'ratedInputVoltage', v)} unit="V" disabled={!isCustom} />
              <InputField label="起動電圧" value={pcs.startupVoltage} onChange={(v) => onChange(pcs.id, 'startupVoltage', v)} unit="V" disabled={!isCustom} />
              <InputField label="MPPT下限" value={pcs.mpptMinVoltage} onChange={(v) => onChange(pcs.id, 'mpptMinVoltage', v)} unit="V" disabled={!isCustom} />
              <InputField label="MPPT上限" value={pcs.mpptMaxVoltage} onChange={(v) => onChange(pcs.id, 'mpptMaxVoltage', v)} unit="V" disabled={!isCustom} />
              <InputField label="最大入力電圧" value={pcs.maxInputVoltage} onChange={(v) => onChange(pcs.id, 'maxInputVoltage', v)} unit="V" disabled={!isCustom} />
              <InputField label="最大入力電流/回路" value={pcs.maxInputCurrentPerCircuit} onChange={(v) => onChange(pcs.id, 'maxInputCurrentPerCircuit', v)} unit="A" disabled={!isCustom} />
              <InputField label="最大短絡電流/回路" value={pcs.maxIscPerCircuit} onChange={(v) => onChange(pcs.id, 'maxIscPerCircuit', v)} unit="A" disabled={!isCustom} />
            </div>
          </div>
        );})}
        <button onClick={onAdd} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
          <i className="fa-solid fa-plus"></i>
          PCSを追加
        </button>
      </section>
    );

    // --- Condition Form ---
    const ConditionForm = ({ condition, onChange }) => (
      <section className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
        <h2 className="flex items-center gap-2 text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">
          <i className="fa-solid fa-gear text-slate-500 text-xl"></i>
          設置条件
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <InputField label="想定最低気温" value={condition.minTemperature} onChange={(v) => onChange('minTemperature', v)} unit="℃" />
          <InputField label="目標過積載率" value={condition.targetOverloadRatio} onChange={(v) => onChange('targetOverloadRatio', v)} unit="%" />
          <InputField label="直列数 (任意指定)" value={condition.manualSeriesCount} onChange={(v) => onChange('manualSeriesCount', v)} unit="枚" type="number" />
        </div>
        <p className="text-xs text-slate-400 mt-2 ml-1">※ 直列数を0にすると自動計算されます</p>
      </section>
    );

    // --- GlobalAlerts ---
    const GlobalAlerts = ({ warnings }) => {
      if (!warnings || warnings.length === 0) return null;
      return (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 animate-pulse mt-4">
          <div className="flex items-start gap-3">
            <i className="fa-solid fa-triangle-exclamation text-yellow-600 mt-1"></i>
            <div className="space-y-1">
              <h4 className="text-sm font-bold text-yellow-800">注意が必要です</h4>
              {warnings.map((warn, idx) => (
                <p key={idx} className="text-sm text-yellow-700">{warn}</p>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // --- DesignGuidePanel ---
    const DesignGuidePanel = ({ panel, pcsList, condition }) => {
      const pcs = pcsList[0];
      
      // 数値変換ヘルパー（安全対策）
      const safeNum = (val) => {
        const n = Number(val);
        return Number.isFinite(n) ? n : 0;
      };

      // 必須項目のチェック (数値変換後にチェック)
      const vocVal = safeNum(panel.voc);
      if (!pcs || vocVal === 0) return null;

      // Constants & Assumptions
      const T_cold = safeNum(condition.minTemperature);
      const T_hot = 70; // 想定最高セル温度
      const T_typ = 45; // 常用セル温度
      const SafetyMarginVoc = 0.95;
      
      // Coefficients
      // β_Vmp ≒ α_Voc と仮定
      const alphaVoc = safeNum(panel.tempCoeffVoc) / 100;
      const betaVmp = alphaVoc; 

      // 1. N_max: Voc Check (Cold)
      const vocColdModule = vocVal * (1 + alphaVoc * (T_cold - 25));
      const pcsMaxInputVoltage = safeNum(pcs.maxInputVoltage);
      const nMaxRaw = pcsMaxInputVoltage / (vocColdModule || 1); // 0除算回避
      const nMax = Math.floor(nMaxRaw * SafetyMarginVoc);

      // 2. N_min: Vmp Check (Hot)
      const vmpVal = safeNum(panel.vmp);
      const vmpHotModule = vmpVal * (1 + betaVmp * (T_hot - 25));
      const pcsMpptMinVoltage = safeNum(pcs.mpptMinVoltage);
      // 実務的にはFull Power下限(例:580V)を見るが、データがないのでMPPT下限を使用しつつ注記
      const nMinMppt = Math.ceil(pcsMpptMinVoltage / (vmpHotModule || 1));
      
      // 3. Best Zone (Typical Temp vs Rated Voltage)
      // 定格入力電圧 (なければ600Vと仮定)
      const vRated = safeNum(pcs.ratedInputVoltage) || 600; 
      const vmpTypModule = vmpVal * (1 + betaVmp * (T_typ - 25));
      
      // ベストゾーン: 定格の 0.9 ~ 1.2倍
      const vBestMin = vRated * 0.9;
      const vBestMax = vRated * 1.2;
      
      // この電圧範囲に入るN
      const nBestMin = Math.ceil(vBestMin / (vmpTypModule || 1));
      const nBestMax = Math.floor(vBestMax / (vmpTypModule || 1));
      
      // 範囲オーバーラップチェック
      const nGuideMin = Math.max(nMinMppt, nBestMin);
      const nGuideMax = Math.min(nMax, nBestMax);
      const isFeasible = nGuideMin <= nGuideMax;

      // 4. Current Check (Imp & Isc)
      const currentLimit = safeNum(pcs.maxInputCurrentPerCircuit); // MPPTあたりの最大入力電流と仮定
      const iscLimit = safeNum(pcs.maxIscPerCircuit); // MPPTあたりの最大短絡電流
      
      const impVal = safeNum(panel.imp);
      const iscVal = safeNum(panel.isc);
      
      const imp1 = impVal;
      const imp2 = impVal * 2;
      const isc1 = iscVal;
      const isc2 = iscVal * 2;
      
      const isImp1Ok = imp1 <= currentLimit;
      const isImp2Ok = imp2 <= currentLimit;
      const isIsc1Ok = isc1 <= iscLimit;
      const isIsc2Ok = isc2 <= iscLimit;

      return (
        <section className="bg-slate-100 rounded-xl p-6 border border-slate-300 space-y-6 mt-8">
          <div className="flex items-center gap-2 border-b border-slate-200 pb-2">
            <i className="fa-solid fa-book-open text-slate-500"></i>
            <h3 className="text-lg font-bold text-slate-700">適正設計ガイド (Design Guide)</h3>
          </div>

          {/* Voltage Guide */}
          <div>
            <h4 className="text-sm font-bold text-slate-600 mb-3 flex items-center gap-2">
              <span className="w-1 h-4 bg-indigo-500 rounded-full"></span>
              電圧設計 (Voltage Design)
            </h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                {/* Column 1: 前提条件 */}
                <div className="space-y-2">
                <h4 className="font-bold text-slate-600 text-xs uppercase tracking-wider">計算前提</h4>
                <ul className="list-disc list-inside text-slate-500 space-y-1 text-xs">
                    <li>最低セル温度: <span className="font-bold text-slate-700">{T_cold}℃</span></li>
                    <li>最高セル温度: <span className="font-bold text-slate-700">{T_hot}℃</span> (仮定)</li>
                    <li>PCS定格電圧: <span className="font-bold text-slate-700">{vRated}V</span></li>
                </ul>
                </div>

                {/* Column 2: 制約範囲 */}
                <div className="space-y-2">
                <h4 className="font-bold text-slate-600 text-xs uppercase tracking-wider">直列数 制約範囲</h4>
                <div className="bg-white p-3 rounded border border-slate-200 space-y-2">
                    <div className="flex justify-between items-center">
                    <span className="text-slate-500 text-xs">Voc制約 (寒冷時)</span>
                    <span className="font-bold text-slate-800">{nMax} 枚以下</span>
                    </div>
                    <div className="flex justify-between items-center">
                    <span className="text-slate-500 text-xs">Vmp制約 (高温時)</span>
                    <span className="font-bold text-slate-800">{nMinMppt} 枚以上</span>
                    </div>
                </div>
                </div>

                {/* Column 3: ベストゾーン */}
                <div className="space-y-2">
                <h4 className="font-bold text-slate-600 text-xs uppercase tracking-wider">推奨ベストゾーン</h4>
                <div className={`p-3 rounded border space-y-2 ${isFeasible ? "bg-emerald-50 border-emerald-200" : "bg-red-50 border-red-200"}`}>
                    <div className="text-center">
                    {isFeasible ? (
                        <p className="text-2xl font-bold text-emerald-700">
                        {nGuideMin} 〜 {nGuideMax} <span className="text-base font-normal text-emerald-600">枚</span>
                        </p>
                    ) : (
                        <p className="text-sm font-bold text-red-600">適正範囲なし</p>
                    )}
                    </div>
                    <div className="text-xs text-center text-slate-500">
                    目標Vmp: {(vmpTypModule * nGuideMin).toFixed(0)}V 〜 {(vmpTypModule * nGuideMax).toFixed(0)}V
                    </div>
                </div>
                </div>
            </div>
          </div>
          
          {/* Current Guide */}
          <div className="pt-4 border-t border-slate-200">
            <h4 className="text-sm font-bold text-slate-600 mb-3 flex items-center gap-2">
              <span className="w-1 h-4 bg-orange-500 rounded-full"></span>
              電流設計 (Current Design / MPPT)
            </h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Spec Info */}
                <div className="bg-white p-4 rounded border border-slate-200 text-xs">
                    <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100">
                        <span className="text-slate-500">パネル Imp / Isc</span>
                        <span className="font-bold text-slate-700">{impVal.toFixed(2)} A / {iscVal.toFixed(2)} A</span>
                    </div>
                    <div className="flex justify-between items-center">
                        <span className="text-slate-500">PCS最大入力電流 (MPPT)</span>
                        <span className="font-bold text-slate-700">{currentLimit} A</span>
                    </div>
                    <div className="flex justify-between items-center mt-1">
                        <span className="text-slate-500">PCS最大短絡電流 (MPPT)</span>
                        <span className="font-bold text-slate-700">{iscLimit} A</span>
                    </div>
                </div>

                {/* Parallel Check */}
                <div className="grid grid-cols-2 gap-4">
                    {/* 1 String Pattern */}
                    <div className={`p-3 rounded border flex flex-col items-center justify-center gap-1 ${
                        isImp1Ok ? "bg-blue-50 border-blue-100" : "bg-red-50 border-red-100"
                    }`}>
                        <span className="text-xs font-bold text-slate-500">1回路/MPPT</span>
                        <span className={`text-lg font-bold ${isImp1Ok ? "text-blue-700" : "text-red-600"}`}>
                            {isImp1Ok ? "OK" : "NG"}
                        </span>
                        <span className="text-[10px] text-slate-400">Imp: {imp1.toFixed(1)}A</span>
                    </div>

                    {/* 2 String Pattern */}
                    <div className={`p-3 rounded border flex flex-col items-center justify-center gap-1 ${
                        isImp2Ok ? "bg-blue-50 border-blue-100" : "bg-red-50 border-red-100"
                    }`}>
                        <span className="text-xs font-bold text-slate-500">2回路並列/MPPT</span>
                        <span className={`text-lg font-bold ${isImp2Ok ? "text-blue-700" : "text-red-600"}`}>
                            {isImp2Ok ? "OK" : "NG"}
                        </span>
                        <span className="text-[10px] text-slate-400">Imp: {imp2.toFixed(1)}A</span>
                    </div>
                </div>
            </div>
            <p className="text-[10px] text-slate-400 mt-2">
              ※ 2回路並列/MPPTとは、1つのMPPT入力に対して2つのストリングを接続する構成(例: 入力1-2で1MPPTなど)を指します。
              NGの場合、クリッピング損失が発生したり、安全上のリスクがあるため接続できません。
            </p>

            <div className="mt-4 p-4 bg-slate-50 rounded border border-slate-200 text-[11px] text-slate-600 leading-relaxed space-y-3">
                <p className="font-bold border-b border-slate-200 pb-1">【パワーコンディショナの入力系統における許容電流の取り扱い原則】</p>
                <p>
                    入力系統（MPPT）の許容電流、ストリング単位の定格電流、入力短絡電流の上限は、それぞれ独立した設計上の制約として扱います。
                </p>
                <div className="pl-2 border-l-2 border-slate-300">
                    <p className="mb-1">
                        ストリングを並列接続した場合、並列合成電流の計算値が入力系統の許容電流値を上回る場合でも、実際の入力電流は当該許容値により制限されます（ピークカット）。
                    </p>
                    <div className="bg-white p-2 rounded border border-slate-100 text-slate-500 my-1">
                        <p className="font-bold text-[10px] mb-1">例：</p>
                        <ul className="list-disc list-inside">
                            <li>ストリング電流が 17A</li>
                            <li>2並列で 34A</li>
                            <li>MPPT側の許容電流が 30A</li>
                        </ul>
                        <p className="mt-1 text-indigo-600 font-bold">→ 実際に扱われる電流は 30A に制限される。</p>
                    </div>
                    <p>このような構成は動作としては成立しますが、推奨される設計とは限らない点にご注意ください。</p>
                </div>
                <p>
                    ストリングの短絡電流については、並列構成による合成短絡電流が入力短絡電流の許容上限を超える場合、<span className="font-bold text-red-600">接続不可</span>と判断します。
                </p>
                <p className="font-bold text-red-500 pt-2 border-t border-slate-200">
                    いずれかの仕様値を超過する構成は、安全性および機器仕様遵守の観点から不適合となります。
                </p>
            </div>
          </div>
        </section>
      );
    };

    // --- SummaryPanel ---
    const SummaryPanel = ({ result, panel, pcsList }) => {
      if (result.summaries.length === 0) return null;

      return (
        <section className="space-y-6">
          <div className="flex justify-end">
            <button
                onClick={() => exportToExcel(result, panel, pcsList, { minTemperature: -10, targetOverloadRatio: 120 })} 
                className="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-sm transition-all"
            >
                <i className="fa-solid fa-file-excel"></i>
                Excel出力
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {/* Voltage Info Card */}
            <div className="bg-white rounded-xl p-5 shadow-sm border border-slate-200 flex flex-col justify-between relative overflow-hidden group">
              <div className="absolute top-0 right-0 p-4 opacity-10 text-indigo-500 group-hover:scale-110 transition-transform">
                 <i className="fa-solid fa-bolt text-6xl"></i>
              </div>
              <div>
                 <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">設計: 直列数 & 電圧</p>
                 <div className="flex items-baseline gap-1">
                   <span className="text-3xl font-bold text-indigo-700">
                     {result.assignments[0]?.stringDesign?.seriesModules || 0}
                   </span>
                   <span className="text-sm font-medium text-slate-500">枚直列</span>
                 </div>
              </div>
              <div className="mt-4 pt-3 border-t border-slate-100 space-y-1">
                <div className="flex justify-between items-center text-xs">
                   <span className="text-slate-500">動作電圧 (Vmp)</span>
                   <span className="font-bold text-slate-700">
                     {result.assignments[0]?.stringDesign?.vmpString.toFixed(1) || 0} V
                   </span>
                </div>
                <div className="flex justify-between items-center text-xs">
                   <span className="text-slate-500">低温時Voc</span>
                   <span className="font-bold text-slate-700">
                      {result.assignments[0]?.stringDesign?.vocStringCold.toFixed(1) || 0} V
                   </span>
                </div>
              </div>
            </div>

            {/* PV Capacity */}
            <div className="bg-white rounded-xl p-5 shadow-sm border border-slate-200 flex flex-col justify-between relative overflow-hidden group">
              <div className="absolute top-0 right-0 p-4 opacity-10 text-orange-500 group-hover:scale-110 transition-transform">
                <i className="fa-solid fa-bolt text-6xl"></i>
              </div>
              <div>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">PV システム容量</p>
                <div className="flex items-baseline gap-1">
                  <span className="text-3xl font-bold text-slate-800">{result.totalPvCapacityKw.toFixed(2)}</span>
                  <span className="text-sm font-medium text-slate-500">kW</span>
                </div>
              </div>
              <div className="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center text-xs">
                <span className="text-slate-500">パネル総数</span>
                <span className="font-bold text-slate-700">{panel.moduleCount} 枚</span>
              </div>
            </div>

            {/* PCS Capacity */}
            <div className="bg-white rounded-xl p-5 shadow-sm border border-slate-200 flex flex-col justify-between relative overflow-hidden group">
              <div className="absolute top-0 right-0 p-4 opacity-10 text-blue-500 group-hover:scale-110 transition-transform">
                <i className="fa-solid fa-server text-6xl"></i>
              </div>
              <div>
                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">PCS 定格出力合計</p>
                <div className="flex items-baseline gap-1">
                  <span className="text-3xl font-bold text-slate-800">{result.totalPcsCapacityKw.toFixed(2)}</span>
                  <span className="text-sm font-medium text-slate-500">kW</span>
                </div>
              </div>
               <div className="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center text-xs">
                <span className="text-slate-500">台数</span>
                <span className="font-bold text-slate-700">{result.summaries.length} 台</span>
              </div>
            </div>

            {/* Overload Ratio */}
            <div className={`rounded-xl p-5 shadow-sm border flex flex-col justify-between relative overflow-hidden group ${
                result.totalOverloadRatio > 150 ? "bg-red-50 border-red-200" : "bg-emerald-50 border-emerald-200"
            }`}>
              <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform ${
                  result.totalOverloadRatio > 150 ? "text-red-600" : "text-emerald-600"
              }`}>
                <i className="fa-solid fa-battery-half text-6xl"></i>
              </div>
              <div>
                <p className={`text-xs font-bold uppercase tracking-wider mb-1 ${
                    result.totalOverloadRatio > 150 ? "text-red-400" : "text-emerald-600"
                }`}>全体過積載率</p>
                <div className="flex items-baseline gap-1">
                  <span className={`text-3xl font-bold ${
                      result.totalOverloadRatio > 150 ? "text-red-700" : "text-emerald-700"
                  }`}>{result.totalOverloadRatio.toFixed(1)}</span>
                  <span className={`text-sm font-medium ${
                      result.totalOverloadRatio > 150 ? "text-red-500" : "text-emerald-600"
                  }`}>%</span>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {result.summaries.map(summary => {
              const hasWarning = summary.warnings.length > 0;
              const pcsSpec = pcsList.find(p => p.id === summary.pcsId);
              const totalCircuits = pcsSpec ? pcsSpec.totalCircuits : '-';

              return (
                <div key={summary.pcsId} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm flex flex-col">
                  <div className="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                      <i className="fa-solid fa-server text-slate-400"></i>
                      <span className="font-bold text-slate-700 text-sm">{summary.pcsId}</span>
                    </div>
                    <span className={`text-[10px] px-2 py-1 rounded-full font-bold ${
                        hasWarning ? "bg-red-100 text-red-600" : "bg-green-100 text-green-600"
                    }`}>
                      {hasWarning ? "要確認" : "OK"}
                    </span>
                  </div>
                  <div className="p-4 flex-1 flex flex-col gap-4">
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div className="space-y-1">
                        <span className="text-xs text-slate-400">入力枚数</span>
                        <p className="font-bold text-slate-700">{summary.totalModulesAssigned} <span className="text-xs font-normal">枚</span></p>
                      </div>
                      <div className="space-y-1">
                        <span className="text-xs text-slate-400">使用回路</span>
                        <p className="font-bold text-slate-700">
                          {summary.usedCircuits} <span className="text-xs font-normal text-slate-400">/ {totalCircuits}</span>
                        </p>
                      </div>
                      <div className="space-y-1">
                        <span className="text-xs text-slate-400">PV入力</span>
                        <p className="font-bold text-slate-700">{summary.pvCapacityKw.toFixed(2)} <span className="text-xs font-normal">kW</span></p>
                      </div>
                      <div className="space-y-1">
                        <span className="text-xs text-slate-400">過積載率</span>
                        <p className={`font-bold ${summary.overloadRatio > 150 ? "text-red-600" : "text-slate-700"}`}>
                          {summary.overloadRatio.toFixed(1)} <span className="text-xs font-normal">%</span>
                        </p>
                      </div>
                    </div>
                    {hasWarning ? (
                      <div className="mt-auto bg-red-50/50 rounded border border-red-100 p-2 space-y-1.5">
                        {summary.warnings.map((w, i) => (
                          <div key={i} className="flex items-start gap-2 text-red-700 text-xs leading-snug">
                            <i className="fa-solid fa-circle-info mt-1 flex-shrink-0 opacity-70"></i>
                            <span>{w}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="mt-auto flex items-center gap-2 text-xs text-green-600 bg-green-50/50 p-2 rounded border border-green-100">
                        <i className="fa-solid fa-circle-check"></i>
                        <span>すべての制約を満たしています</span>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      );
    };

    // --- VoltagePatternsPanel ---
    const VoltagePatternsPanel = ({ result, pcsList, panel }) => {
      const patterns = React.useMemo(() => {
        const map = new Map();
        result.assignments.forEach(a => {
          const n = a.stringDesign?.seriesModules || 0;
          if (n === 0) return;
          if (!map.has(n)) {
            map.set(n, { count: 0, assignments: [] });
          }
          const entry = map.get(n);
          entry.count++;
          entry.assignments.push(a);
        });
        return Array.from(map.entries()).sort((a, b) => b[0] - a[0]);
      }, [result.assignments]);

      if (patterns.length === 0) return null;

      return (
        <section className="space-y-3">
           <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
             <i className="fa-solid fa-bolt"></i>
             ストリング構成別 電圧詳細
           </h3>
           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
             {patterns.map(([seriesCount, data]) => {
               const vmp = (panel.vmp * seriesCount);
               const vmpStr = vmp.toFixed(1);
               const vocCold = (data.assignments[0].stringDesign?.vocStringCold || 0);
               const vocColdStr = vocCold.toFixed(1);
               
               // この構成を使用しているPCSを特定してチェック
               const usedPcsIds = Array.from(new Set(data.assignments.map(a => a.pcsId)));
               const errors = [];

               usedPcsIds.forEach(pid => {
                 const pcs = pcsList.find(p => p.id === pid);
                 if (!pcs) return;
                 
                 if (vmp < pcs.mpptMinVoltage) {
                    errors.push({ pid, msg: `MPPT下限(${pcs.mpptMinVoltage}V)未満` });
                 } else if (vmp > pcs.mpptMaxVoltage) {
                    errors.push({ pid, msg: `MPPT上限(${pcs.mpptMaxVoltage}V)超過` });
                 }
                 
                 if (vocCold > pcs.maxInputVoltage) {
                    errors.push({ pid, msg: `最大入力(${pcs.maxInputVoltage}V)超過` });
                 }
               });

               const hasError = errors.length > 0;

               return (
                 <div key={seriesCount} className={`rounded-lg border p-4 shadow-sm transition-all ${
                     hasError ? "bg-red-50 border-red-200" : "bg-white border-slate-200"
                 }`}>
                   <div className="flex justify-between items-start mb-3">
                     <div className="flex items-baseline gap-2">
                       <span className="text-2xl font-bold text-slate-800">{seriesCount}</span>
                       <span className="text-xs font-bold text-slate-500">枚直列</span>
                     </div>
                     <div className="px-2 py-1 bg-slate-100 rounded text-xs font-mono text-slate-600">
                       × {data.count} 回路
                     </div>
                   </div>
                   <div className="space-y-2 text-sm">
                     <div className="flex justify-between">
                       <span className="text-slate-500">動作電圧 (Vmp)</span>
                       <span className={`font-mono font-bold ${ hasError ? "text-slate-800" : "text-slate-700"}`}>
                         {vmpStr} V
                       </span>
                     </div>
                     <div className="flex justify-between">
                        <span className="text-slate-500">低温時開放 (Voc)</span>
                        <span className={`font-mono font-bold ${ hasError ? "text-slate-800" : "text-slate-700"}`}>
                          {vocColdStr} V
                        </span>
                     </div>
                   </div>
                   {hasError && (
                     <div className="mt-3 pt-2 border-t border-red-100 text-xs text-red-600 space-y-1">
                       <div className="flex items-center gap-1.5 font-bold mb-1">
                         <i className="fa-solid fa-triangle-exclamation"></i>
                         <span>電圧制約違反</span>
                       </div>
                       {errors.map((err, idx) => (
                         <div key={idx} className="pl-4 relative">
                           <span className="absolute left-0 top-1 w-1 h-1 bg-red-400 rounded-full"></span>
                           <span className="font-bold">{err.pid}:</span> {err.msg}
                         </div>
                       ))}
                     </div>
                   )}
                 </div>
               );
             })}
           </div>
        </section>
      );
    };

    // --- ResultTable ---
    const ResultTable = ({ result, onAssignmentChange }) => {
      if (result.assignments.length === 0) return null;

      const assignmentsByPcs = result.assignments.reduce((acc, curr) => {
        if (!acc[curr.pcsId]) acc[curr.pcsId] = [];
        acc[curr.pcsId].push(curr);
        return acc;
      }, {});

      const pcsIds = Object.keys(assignmentsByPcs);
      const maxCircuits = Math.max(...pcsIds.map(id => assignmentsByPcs[id].length));
      const rows = Array.from({ length: maxCircuits }, (_, i) => i + 1);

      const handleCellClick = (e, pcsId, circuitIndex) => {
          if (!onAssignmentChange) return;
          e.preventDefault();
          onAssignmentChange(pcsId, circuitIndex, 1);
      };
      const handleCellContextMenu = (e, pcsId, circuitIndex) => {
          if (!onAssignmentChange) return;
          e.preventDefault();
          onAssignmentChange(pcsId, circuitIndex, -1);
      };

      return (
        <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
          <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
            <div className="flex items-center gap-2">
              <i className="fa-solid fa-grip text-slate-500"></i>
              <div>
                <h3 className="font-bold text-slate-700 leading-none">回路割付表 (Matrix)</h3>
                <div className="flex items-center gap-1 mt-1 text-[10px] text-slate-400">
                    <i className="fa-solid fa-arrow-pointer"></i>
                    <span>左クリック: +1 / 右クリック: -1</span>
                </div>
              </div>
            </div>
            <div className="flex gap-4 text-xs">
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 bg-emerald-500 rounded-sm"></div>
                <span className="text-slate-600">使用中</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 bg-slate-100 border border-slate-200 rounded-sm"></div>
                <span className="text-slate-600">未使用</span>
              </div>
            </div>
          </div>
          <div className="overflow-x-auto flex-1">
            <table className="w-full text-sm text-left text-slate-600 border-collapse">
              <thead className="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 z-10 shadow-sm">
                <tr>
                  <th className="px-4 py-3 w-16 text-center font-bold border-b border-slate-200 bg-slate-100">回路No</th>
                  {pcsIds.map(pcsId => (
                    <th key={pcsId} className="px-4 py-3 text-center border-l border-b border-slate-200 min-w-[100px] font-bold bg-slate-100">{pcsId}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {rows.map(rowNum => (
                  <tr key={rowNum} className="hover:bg-slate-50 transition-colors">
                    <td className="px-2 py-2 font-mono font-medium text-center text-slate-500 bg-slate-50/50 border-b border-slate-100 text-xs">{String(rowNum).padStart(2, '0')}</td>
                    {pcsIds.map(pcsId => {
                      const assignment = assignmentsByPcs[pcsId].find(a => a.circuitIndex === rowNum);
                      const modules = assignment?.stringDesign?.seriesModules || 0;
                      const isEmpty = modules === 0;
                      return (
                        <td 
                            key={`${pcsId}-${rowNum}`} 
                            className="p-1 border-l border-b border-slate-100 text-center align-middle cursor-pointer select-none"
                            onClick={(e) => handleCellClick(e, pcsId, rowNum)}
                            onContextMenu={(e) => handleCellContextMenu(e, pcsId, rowNum)}
                            title="クリックで増減"
                        >
                          <div className={`h-8 w-full flex items-center justify-center rounded text-xs font-bold transition-all active:scale-95 ${
                              isEmpty ? "bg-slate-50 text-slate-300 border border-slate-100 hover:bg-slate-100" : "bg-emerald-500 text-white shadow-sm border border-emerald-600 hover:bg-emerald-400"
                          }`}>
                            {isEmpty ? "-" : modules}
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
      );
    };

    // ==========================================
    // Main App
    // ==========================================
    
    const INITIAL_PANEL = {
      manufacturer: '', model: '', voc: '', vmp: '', isc: '', imp: '', pmax: '', tempCoeffVoc: '', tempCoeffIsc: '', moduleCount: ''
    };
    const INITIAL_PCS = {
      id: 'PCS1', manufacturer: '', model: '', ratedPower: '', totalCircuits: '', mpptCount: '', startupVoltage: '', mpptMinVoltage: '', mpptMaxVoltage: '', maxInputVoltage: '', maxInputCurrentPerCircuit: '', maxIscPerCircuit: '', maxIscTotal: '', efficiency: ''
    };
    const INITIAL_CONDITION = {
      minTemperature: -10, targetOverloadRatio: 145, manualSeriesCount: 0
    };

    function App() {
      const [panelPresets, setPanelPresets] = useState([]);
      const [panel, setPanel] = useState(INITIAL_PANEL);
      
      // Initialize presets from default + localStorage
      useEffect(() => {
        const stored = localStorage.getItem('customPanelPresets');
        const customs = stored ? JSON.parse(stored) : [];
        setPanelPresets([...DEFAULT_PANEL_PRESETS, ...customs]);
      }, []);

      const handleSaveCustomPanel = useCallback(() => {
        if (!panel.manufacturer || !panel.model) {
          alert('保存するにはメーカーと型式を入力してください');
          return;
        }
        const newPreset = {
          manufacturer: panel.manufacturer,
          model: panel.model,
          pmax: Number(panel.pmax),
          voc: Number(panel.voc),
          vmp: Number(panel.vmp),
          isc: Number(panel.isc),
          imp: Number(panel.imp),
          tempCoeffVoc: Number(panel.tempCoeffVoc),
          tempCoeffIsc: Number(panel.tempCoeffIsc)
        };
        
        // Save to localStorage
        const stored = localStorage.getItem('customPanelPresets');
        const customs = stored ? JSON.parse(stored) : [];
        // Remove duplicate if exists
        const filtered = customs.filter(p => p.model !== newPreset.model);
        const updatedCustoms = [...filtered, newPreset];
        
        localStorage.setItem('customPanelPresets', JSON.stringify(updatedCustoms));
        
        // Update State
        setPanelPresets([...DEFAULT_PANEL_PRESETS, ...updatedCustoms]);
        alert(`カスタムパネル「${newPreset.model}」をブラウザに保存しました`);
      }, [panel]);

      const [pcsList, setPcsList] = useState([INITIAL_PCS]);
      const [condition, setCondition] = useState(INITIAL_CONDITION);
      const [result, setResult] = useState(null);
      const [isCalculating, setIsCalculating] = useState(false);
      const [manualAssignments, setManualAssignments] = useState(null);

      const handlePanelChange = useCallback((field, value) => setPanel(prev => ({ ...prev, [field]: value })), []);
      
      const handlePanelPresetSelect = useCallback((modelName) => {
        if (modelName === 'CUSTOM') {
            setPanel(prev => ({
                ...prev,
                manufacturer: '', model: '', voc: '', vmp: '', isc: '', imp: '', pmax: '', tempCoeffVoc: '', tempCoeffIsc: ''
                // keep moduleCount
            }));
        } else {
            // Search in panelPresets state instead of constant
            const preset = panelPresets.find(p => p.model === modelName);
            if (preset) {
                setPanel(prev => ({ ...prev, ...preset }));
            }
        }
      }, [panelPresets]);

      const handlePcsChange = useCallback((id, field, value) => setPcsList(prev => prev.map(pcs => pcs.id === id ? { ...pcs, [field]: value } : pcs)), []);
      
      const handleAddPcs = useCallback(() => setPcsList(prev => {
        const lastPcs = prev[prev.length - 1];
        const baseData = lastPcs ? { ...lastPcs } : { ...INITIAL_PCS };
        return [...prev, { ...baseData, id: `PCS${prev.length + 1}` }];
      }), []);

      const handleRemovePcs = useCallback((id) => setPcsList(prev => prev.filter(pcs => pcs.id !== id)), []);
      const handleConditionChange = useCallback((field, value) => setCondition(prev => ({ ...prev, [field]: value })), []);
      
      // Preset selection handler
      const handlePcsPresetSelect = useCallback((id, modelName) => {
        if (modelName === 'CUSTOM') {
            // Reset to blank values for custom input
            setPcsList(prev => prev.map(pcs => pcs.id === id ? {
                ...pcs,
                manufacturer: '',
                model: '', // Empty model indicates custom state
                ratedPower: '',
                efficiency: '',
                totalCircuits: '',
                mpptCount: '',
                startupVoltage: '',
                mpptMinVoltage: '',
                mpptMaxVoltage: '',
                maxInputVoltage: '',
                maxInputCurrentPerCircuit: '',
                maxIscPerCircuit: ''
            } : pcs));
        } else {
            const preset = PCS_PRESETS.find(p => p.model === modelName);
            if (preset) {
                setPcsList(prev => prev.map(pcs => pcs.id === id ? { ...pcs, ...preset } : pcs));
            }
        }
      }, []);

      const handleCalculate = () => {
        setIsCalculating(true);
        setTimeout(() => {
          try {
            const res = calculateDesign(panel, pcsList, condition);
            setResult(res);
            setManualAssignments(null);
          } catch (e) {
            console.error(e);
            alert('計算中にエラーが発生しました');
          } finally {
            setIsCalculating(false);
          }
        }, 400);
      };

      const handleAssignmentChange = useCallback((pcsId, circuitIndex, change) => {
        if (!result) return;
        const currentAssignments = manualAssignments || result.assignments;
        
        const newAssignments = currentAssignments.map(a => {
          if (a.pcsId === pcsId && a.circuitIndex === circuitIndex) {
            const currentSeries = a.stringDesign?.seriesModules || 0;
            const newSeries = Math.max(0, currentSeries + change);
            let newStringDesign = null;
            if (newSeries > 0) {
                const vocColdModule = calculateVocCold(panel, condition.minTemperature);
                newStringDesign = {
                    seriesModules: newSeries,
                    vmpString: panel.vmp * newSeries,
                    vocStringCold: vocColdModule * newSeries
                };
            }
            return {
              ...a,
              stringDesign: newStringDesign,
              currentImp: newStringDesign ? panel.imp : 0,
              currentIsc: newStringDesign ? panel.isc : 0
            };
          }
          return a;
        });
        setManualAssignments(newAssignments);
      }, [result, manualAssignments, panel, condition.minTemperature]);

      const finalResult = useMemo(() => {
          if (!result) return null;
          if (!manualAssignments) return result;

          const assignments = manualAssignments;
          let totalModulesAssigned = 0;
          let totalPvCapacityW = 0;
          let totalPcsCapacityW = 0;
          const newSummaries = [];
          const globalWarnings = [];

          for(const pcs of pcsList) {
              totalPcsCapacityW += pcs.ratedPower;
              const pcsAssignments = assignments.filter(a => a.pcsId === pcs.id);
              let pcsModules = 0;
              let usedCircuits = 0;
              
              let pcsWarnings = [];
              const voltageWarnings = new Set();
              const mpptCounts = {};

              pcsAssignments.forEach(a => {
                  if(a.stringDesign && a.stringDesign.seriesModules > 0) {
                      pcsModules += a.stringDesign.seriesModules;
                      usedCircuits++;
                      
                      // MPPT集計
                      const mpptIdx = a.mpptGroupIndex;
                      mpptCounts[mpptIdx] = (mpptCounts[mpptIdx] || 0) + 1;

                      // 電圧チェック
                      const vWarns = checkVoltageConstraints(pcs, a.stringDesign.vmpString, a.stringDesign.vocStringCold);
                      vWarns.forEach(w => voltageWarnings.add(w));
                  }
              });
              
              // 電流チェック (MPPT単位)
              for (const [mpptIdx, count] of Object.entries(mpptCounts)) {
                  const totalImp = count * panel.imp;
                  const totalIsc = count * panel.isc;
                  // Note: maxInputCurrentPerCircuit is treated as Per MPPT limit here as per user context
                  if (totalImp > pcs.maxInputCurrentPerCircuit) {
                      pcsWarnings.push(`警告: MPPT${mpptIdx} 入力電流(${totalImp.toFixed(1)}A)が上限(${pcs.maxInputCurrentPerCircuit}A)を超過`);
                  }
                  if (totalIsc > pcs.maxIscPerCircuit) {
                      pcsWarnings.push(`警告: MPPT${mpptIdx} 短絡電流(${totalIsc.toFixed(1)}A)が上限(${pcs.maxIscPerCircuit}A)を超過`);
                  }
              }

              pcsWarnings = [...pcsWarnings, ...voltageWarnings];

              const pcsPvPower = pcsModules * panel.pmax;
              const overloadRatio = pcs.ratedPower > 0 ? (pcsPvPower / pcs.ratedPower) * 100 : 0;
              totalModulesAssigned += pcsModules;
              totalPvCapacityW += pcsPvPower;
              
              // 合計短絡電流チェック
              const totalIsc = usedCircuits * panel.isc;
              if (totalIsc > pcs.maxIscTotal) {
                  pcsWarnings.push(`警告: PCS合計短絡電流(${totalIsc.toFixed(1)}A)が最大値(${pcs.maxIscTotal}A)を超過`);
              }

              const originalSummary = result.summaries.find(s => s.pcsId === pcs.id);
              
              // 過積載率チェック
              if (overloadRatio < condition.targetOverloadRatio * 0.8 && pcs.ratedPower > 0) {
                  pcsWarnings.push(`情報: 過積載率(${overloadRatio.toFixed(1)}%)が目標(${condition.targetOverloadRatio}%)より大幅に低いです`);
              }

              newSummaries.push({
                  ...originalSummary,
                  totalModulesAssigned: pcsModules,
                  usedCircuits: usedCircuits,
                  overloadRatio: overloadRatio,
                  warnings: pcsWarnings,
                  pvCapacityKw: pcsPvPower / 1000,
              });
          }

          const remaining = panel.moduleCount - totalModulesAssigned;
          if (remaining !== 0) {
              if (remaining > 0) {
                globalWarnings.push(`注意: ${remaining} 枚のパネルが配置されずに残っています。`);
              } else {
                 globalWarnings.push(`警告: パネル総数(${panel.moduleCount}枚)に対し、${-remaining} 枚多く割り当てられています！`);
              }
          }
          
          const totalOverloadRatio = totalPcsCapacityW > 0 ? (totalPvCapacityW / totalPcsCapacityW) * 100 : 0;

          return {
              ...result,
              assignments: manualAssignments,
              summaries: newSummaries,
              totalOverloadRatio,
              totalPvCapacityKw: totalPvCapacityW / 1000,
              globalWarnings
          };
      }, [result, manualAssignments, panel, pcsList, condition.targetOverloadRatio]);

      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50">
            <div className="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-gradient-to-br from-orange-400 to-red-500 text-white p-2 rounded-lg shadow-md">
                  <i className="fa-solid fa-bolt text-xl"></i>
                </div>
                <div>
                  <h1 className="text-lg font-bold tracking-tight text-slate-900 leading-none">Solar Circuit Designer</h1>
                  <span className="text-[10px] font-medium text-slate-500 uppercase tracking-wider">PV Plant Engineering Tool</span>
                </div>
              </div>
              <div className="hidden md:block text-xs text-slate-400 text-right">
                <p>Last Updated: 2025.12.01</p>
                <p>Version 1.3.0</p>
              </div>
            </div>
          </header>

          <main className="flex-1 w-full max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
              
              {/* Left Column */}
              <div className="xl:col-span-5 space-y-6 xl:sticky xl:top-24 overflow-y-auto xl:max-h-[calc(100vh-8rem)] scrollbar-hide pb-4">
                <PanelForm 
                    panel={panel} 
                    onChange={handlePanelChange} 
                    onPresetSelect={handlePanelPresetSelect} 
                    presets={panelPresets}
                    onSaveCustom={handleSaveCustomPanel}
                />
                
                {/* Simulation Button (Top) */}
                <button
                  onClick={handleCalculate}
                  disabled={isCalculating}
                  className="w-full py-3 bg-slate-700 hover:bg-slate-600 active:bg-slate-800 text-white rounded-lg font-bold shadow transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                >
                  {isCalculating ? (
                    <><i className="fa-solid fa-rotate fa-spin"></i> 計算中...</>
                  ) : (
                    <><i className="fa-solid fa-calculator"></i> 設計シミュレーション実行</>
                  )}
                </button>

                <PcsListForm 
                  pcsList={pcsList} 
                  onAdd={handleAddPcs} 
                  onRemove={handleRemovePcs} 
                  onChange={handlePcsChange} 
                  onPresetSelect={handlePcsPresetSelect}
                />
                <ConditionForm condition={condition} onChange={handleConditionChange} />
                
                <button
                  onClick={handleCalculate}
                  disabled={isCalculating}
                  className="w-full py-4 bg-slate-900 hover:bg-slate-800 active:bg-slate-950 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-slate-900/20 transition-all flex items-center justify-center gap-3 disabled:opacity-70 disabled:cursor-not-allowed transform active:scale-[0.99]"
                >
                  {isCalculating ? (
                    <><i className="fa-solid fa-rotate fa-spin"></i> Checking Constraints...</>
                  ) : (
                    <><i className="fa-solid fa-calculator"></i> 設計シミュレーション実行</>
                  )}
                </button>
              </div>

              {/* Right Column */}
              <div className="xl:col-span-7 space-y-6 min-h-[calc(100vh-8rem)]">
                {finalResult ? (
                  <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <SummaryPanel result={finalResult} panel={panel} pcsList={pcsList} />
                    <VoltagePatternsPanel result={finalResult} pcsList={pcsList} panel={panel} />
                    <ResultTable result={finalResult} onAssignmentChange={handleAssignmentChange} />
                    <GlobalAlerts warnings={finalResult.globalWarnings} />
                  </div>
                ) : (
                  <div className="h-full flex flex-col items-center justify-center bg-white/50 rounded-3xl border-2 border-dashed border-slate-200 text-slate-400 p-12 text-center mb-8">
                    <div className="bg-slate-100 p-6 rounded-full mb-6">
                      <i className="fa-solid fa-calculator text-6xl opacity-40 text-slate-600"></i>
                    </div>
                    <h3 className="text-xl font-bold text-slate-600 mb-2">Ready to Simulate</h3>
                    <p className="max-w-md mx-auto text-slate-500">左側のパネル仕様・PCS構成・設置条件を入力し、「設計シミュレーション実行」ボタンを押してください。</p>
                  </div>
                )}
                
                {/* Design Guide Panel (Always Visible) */}
                <DesignGuidePanel panel={panel} pcsList={pcsList} condition={condition} />
              </div>
            </div>
          </main>

          <footer className="bg-white border-t border-slate-200 mt-auto">
            <div className="max-w-[1600px] mx-auto px-4 py-6 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-slate-500">
              <p>&copy; 2025 Solar Circuit Designer. All rights reserved.</p>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
